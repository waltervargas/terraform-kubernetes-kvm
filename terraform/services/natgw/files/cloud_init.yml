#cloud-config
# vim: syntax=yaml
hostname: "${hostname}"
ssh_pwauth: True
chpasswd:
  list: |
     root:123321...
  expire: False

packages:
  - iptables-persistent
  - iptraf
  - lsof
  - iftop

# this block enables ip forwarding via sysctl by adding net.ipv4.ip_forward=1 to
# the file local.conf under the directory /stc/sysctl.d according to
# SYSTEMD-SYSCTL.SERVICE(8) and enables NAT via iptables.
write_files:
- path: /etc/sysctl.d/local.conf
  permissions: '0644'
  owner: root:root
  content: |
    # file created via terraform, do not modify manually, will be overwriten
    net.ipv4.ip_forward=1 
    
# - Masquerade all traffic from subnet 10.241.0.0/24
# - Blocks all traffic from interface ens3 to port 22.
- path: /etc/iptables/rules.v4
  content: |
    *nat
    :PREROUTING ACCEPT [0:0]
    :INPUT ACCEPT [0:0]
    :POSTROUTING ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    -A POSTROUTING -s 10.241.0.0/24 -j MASQUERADE
    COMMIT
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    -A INPUT -i ens3 -p tcp -m tcp --dport 22 -j DROP
    COMMIT

# this block restart systemctl service in order to load the configuration added
# on the block above.
runcmd:
  - [ systemctl, restart, systemd-sysctl ]
  - [ systemctl, restart, netfilter-persistent ]
